<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ºï¸ Harita & Parsel Sorgulama</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ—ºï¸ Harita & Parsel Sorgulama</h1>
            <p>Yer arayÄ±n veya haritaya tÄ±klayarak parsel bilgilerini gÃ¶rÃ¼n</p>
        </div>

        <!-- Arama BÃ¶lÃ¼mÃ¼ -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Yer, adres veya landmark arayÄ±n..." autocomplete="off">
                <button id="searchBtn">ğŸ” Ara</button>
                <button id="clearBtn" class="clear-btn">ğŸ—‘ï¸ Temizle</button>
            </div>
            <div id="suggestions" class="suggestions"></div>
            
            <!-- Koordinat Bilgisi -->
            <div id="coordinateInfo" class="coordinate-info" style="display: none;">
                <div class="coord-display">
                    <span>ğŸ“ <strong>SeÃ§ilen Koordinat:</strong> <span id="selectedCoords">-</span></span>
                    <button id="getTkgmBtn" class="tkgm-btn" style="display: none;">ğŸ—ï¸ TKGM Bilgilerini Al</button>
                    <button id="getHepsiEmlakBtn" class="hepsiemlak-btn" style="display: none;">ğŸ  Emsal GÃ¶ster</button>
                </div>
            </div>
        </div>

        <!-- Harita BÃ¶lÃ¼mÃ¼ -->
        <div class="map-section">
            <div class="map-container">
                <div id="map"></div>
                <div class="map-info">
                    <p>ğŸ’¡ <strong>Ä°pucu:</strong> Haritaya tÄ±klayarak o noktanÄ±n parsel bilgilerini alabilirsiniz</p>
                </div>
            </div>
        </div>

        <!-- TKGM SonuÃ§larÄ± -->
        <div id="tkgm-results" class="tkgm-results" style="display: none;">
            <h2>ğŸ—ï¸ Parsel Bilgileri</h2>
            
            <!-- Loading -->
            <div id="tkgm-loading" class="tkgm-loading" style="display: none;">
                <div class="loading-spinner">ğŸ”„</div>
                <p>TKGM'den parsel bilgileri alÄ±nÄ±yor...</p>
            </div>

            <!-- Parsel Bilgileri -->
            <div id="parsel-info" class="parsel-info-grid" style="display: none;">
                <div class="info-card">
                    <h3>ğŸ“ Konum Bilgileri</h3>
                    <div id="location-details"></div>
                </div>

                <div class="info-card">
                    <h3>ğŸ—ï¸ Parsel DetaylarÄ±</h3>
                    <div id="parsel-details"></div>
                </div>

                <div class="info-card">
                    <h3>ğŸ—ºï¸ Geometri Bilgileri</h3>
                    <div id="geometry-details"></div>
                </div>
                
                <!-- Ham JSON Verisi (AÃ§Ä±lÄ±r/KapanÄ±r) -->
                <div id="raw-json">
                    <details>
                        <summary>ğŸ” Ham JSON Verisini GÃ¶rÃ¼ntÃ¼le</summary>
                        <pre id="raw-json-data"></pre>
                    </details>
                </div>
            </div>

            <!-- Hata MesajÄ± -->
            <div id="tkgm-error" class="tkgm-error" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal HTML -->
    <div id="parselModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" id="closeParselModal">&times;</button>
            <h2>Ã–znitelik Bilgisi</h2>
            <table class="modal-table" id="modalParselTable"></table>
        </div>
    </div>

    <script>
    // Google Maps ve Places nesneleri
    let map;
    let placesService;
    let autocompleteService;
    let marker;
    let parselPolygon;
    let selectedCoordinates = null;

    // Harita Ã¼zerinde yapÄ± ve irtifak poligonlarÄ±nÄ± tutmak iÃ§in
    let yapiPolygons = [];

    // Emsal iÅŸaretÃ§ileri
    let hepsiemlakMarkers = [];

    // DOM elemanlarÄ±
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const suggestionsDiv = document.getElementById('suggestions');
    const coordinateInfo = document.getElementById('coordinateInfo');
    const selectedCoordsSpan = document.getElementById('selectedCoords');
    const getTkgmBtn = document.getElementById('getTkgmBtn');
    const getHepsiEmlakBtn = document.getElementById('getHepsiEmlakBtn');
    const tkgmResults = document.getElementById('tkgm-results');
    const tkgmLoading = document.getElementById('tkgm-loading');
    const parselInfo = document.getElementById('parsel-info');
    const tkgmError = document.getElementById('tkgm-error');
    const locationDetails = document.getElementById('location-details');
    const parselDetails = document.getElementById('parsel-details');
    const geometryDetails = document.getElementById('geometry-details');
    const rawJsonData = document.getElementById('raw-json-data');

    // TKGM API URLs
    const PROXY_BASE_URL = 'http://localhost:5000/api/parsel';

    // Harita baÅŸlatma
    function initMap() {
        // VarsayÄ±lan konum (Ä°stanbul)
        const defaultLocation = { lat: 41.0082, lng: 28.9784 };
        
        // Harita oluÅŸturma
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: defaultLocation,
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true,
            zoomControl: true,
            mapTypeId: 'hybrid',
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "on" }]
                }
            ],
            gestureHandling: "greedy",
            scrollwheel: true
        });

        // Places servisi baÅŸlatma
        placesService = new google.maps.places.PlacesService(map);
        autocompleteService = new google.maps.places.AutocompleteService();

        // Event listeners
        setupEventListeners();
        
        // Harita tÄ±klama event'i
        map.addListener('click', (event) => {
            handleMapClick(event.latLng);
        });
        
        console.log('Google Maps baÅŸlatÄ±ldÄ± - Harita tÄ±klama Ã¶zelliÄŸi aktif');
    }

    // Event listener'larÄ± ayarlama
    function setupEventListeners() {
        // Arama butonu
        searchBtn.addEventListener('click', performSearch);
        
        // Temizle butonu
        clearBtn.addEventListener('click', clearAll);
        
        // TKGM butonu
        getTkgmBtn.addEventListener('click', getTkgmData);
        
        // Emsal butonu
        getHepsiEmlakBtn.addEventListener('click', getHepsiEmlakData);
        
        // Enter tuÅŸu
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Otomatik tamamlama
        searchInput.addEventListener('input', handleAutoComplete);
        
        // Ã–nerileri gizleme
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                suggestionsDiv.style.display = 'none';
            }
        });
    }

    // Harita tÄ±klama iÅŸlemi
    function handleMapClick(latLng) {
        const lat = latLng.lat();
        const lng = latLng.lng();
        
        selectedCoordinates = { lat, lng };
        
        // Koordinat bilgisini gÃ¶ster
        selectedCoordsSpan.textContent = `${lat.toFixed(8)}, ${lng.toFixed(8)}`;
        coordinateInfo.style.display = 'block';
        getTkgmBtn.style.display = 'inline-block';
        getHepsiEmlakBtn.style.display = 'inline-block';
        
        // Marker yerleÅŸtir
        if (marker) {
            marker.setMap(null);
        }
        
        marker = new google.maps.Marker({
            position: latLng,
            map: map,
            title: 'SeÃ§ilen Koordinat',
            animation: google.maps.Animation.DROP,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"%3E%3Cpath fill="%23FF6B6B" d="M16 2C10.486 2 6 6.486 6 12c0 6.837 9.269 16.943 9.542 17.285a1 1 0 001.916 0C17.731 28.943 27 18.837 27 12c0-5.514-4.486-10-10-10zm0 14c-2.206 0-4-1.794-4-4s1.794-4 4-4 4 1.794 4 4-1.794 4-4 4z"/%3E%3C/svg%3E',
                scaledSize: new google.maps.Size(32, 32)
            }
        });
        
        // HaritayÄ± bu konuma odakla
        map.setCenter(latLng);
        if (map.getZoom() < 16) {
            map.setZoom(16);
        }
        
        console.log('Harita tÄ±klandÄ±:', lat, lng);
    }

    // TKGM verilerini al
    async function getTkgmData() {
        if (!selectedCoordinates) {
            alert('Ã–nce haritadan bir nokta seÃ§in');
            return;
        }
        
        const { lat, lng } = selectedCoordinates;
        
        // UI'Ä± gÃ¼ncelle
        showTkgmLoading();
        
        try {
            // 1. Koordinatlardan temel parsel bilgilerini al
            const coordinateUrl = `${PROXY_BASE_URL}/koordinat/${lat}/${lng}`;
            console.log('1. AdÄ±m: Koordinat sorgusu yapÄ±lÄ±yor:', coordinateUrl);
            
            const coordinateResponse = await fetch(coordinateUrl);
            const coordinateResult = await coordinateResponse.json();

            if (!coordinateResponse.ok || !coordinateResult.success) {
                const errorMsg = coordinateResult.error || `Koordinat API hatasÄ±: ${coordinateResponse.status}`;
                throw new Error(errorMsg);
            }
            
            const basicData = coordinateResult.data;
            const props = basicData.properties;
            
            let bagimsizBolumData = null;
            let cokBlokluBolumler = null;
            
            // 2. Mahalle ID, ada ve parsel varsa blok sorgusu yap
            if (props && props.mahalleId && props.adaNo && props.parselNo) {
                const { mahalleId, adaNo, parselNo } = props;
                const blokUrl = `${PROXY_BASE_URL}/blok/${mahalleId}/${adaNo}/${parselNo}`;
                console.log('2. AdÄ±m: Blok sorgusu yapÄ±lÄ±yor:', blokUrl);
                const blokResponse = await fetch(blokUrl);
                const blokResult = await blokResponse.json();
                if (blokResponse.ok && blokResult.features && blokResult.features.length > 1) {
                    // Ã‡ok bloklu parsel
                    cokBlokluBolumler = [];
                    for (const blok of blokResult.features) {
                        const blokAdi = blok.properties.blok;
                        const bagimsizBolumUrl = `${PROXY_BASE_URL}/bagimsizbolum/${mahalleId}/${adaNo}/${parselNo}/${blokAdi}`;
                        console.log(`3. AdÄ±m: ${blokAdi} Blok iÃ§in baÄŸÄ±msÄ±z bÃ¶lÃ¼m sorgusu:`, bagimsizBolumUrl);
                        try {
                            const bolumResponse = await fetch(bagimsizBolumUrl);
                            if (!bolumResponse.ok) {
                                // 404 veya baÅŸka bir hata kodu
                                throw new Error(`API HatasÄ±: ${bolumResponse.status}`);
                            }
                            const bolumResult = await bolumResponse.json();
                            if (bolumResult.success) {
                                cokBlokluBolumler.push({ blok: blokAdi, data: bolumResult.data });
                            } else {
                                cokBlokluBolumler.push({ blok: blokAdi, data: null });
                            }
                        } catch (err) {
                            console.warn(`Blok iÃ§in veri alÄ±namadÄ±: ${blokAdi}`, err);
                            cokBlokluBolumler.push({ blok: blokAdi, data: null });
                        }
                    }
                } else {
                    // Tek blok veya blok sorgusu baÅŸarÄ±sÄ±z
                    const bagimsizBolumUrl = `${PROXY_BASE_URL}/bagimsizbolum/${mahalleId}/${adaNo}/${parselNo}`;
                    console.log('3. AdÄ±m: BaÄŸÄ±msÄ±z bÃ¶lÃ¼m sorgusu yapÄ±lÄ±yor:', bagimsizBolumUrl);
                    const bagimsizBolumResponse = await fetch(bagimsizBolumUrl);
                    const bagimsizBolumResult = await bagimsizBolumResponse.json();
                    if (bagimsizBolumResponse.ok && bagimsizBolumResult.success) {
                        bagimsizBolumData = bagimsizBolumResult.data;
                        console.log('BaÄŸÄ±msÄ±z bÃ¶lÃ¼m bilgisi baÅŸarÄ±yla alÄ±ndÄ±.');
                    } else {
                        console.warn('BaÄŸÄ±msÄ±z bÃ¶lÃ¼m bilgisi alÄ±namadÄ± veya bu parselde bulunmuyor.');
                    }
                }
            } else {
                console.log('Ek bilgiler iÃ§in MahalleID, Ada, Parsel bulunamadÄ±.');
            }
            
            // 3. TÃ¼m verileri gÃ¶ster
            displayTkgmData(basicData, bagimsizBolumData, cokBlokluBolumler);
            drawParselPolygon(basicData, props);
            
            // YapÄ± ve irtifak poligonlarÄ±nÄ± Ã§ek
            const yapiUrl = `${PROXY_BASE_URL}/yapi_geometri/${props.mahalleId}/${props.adaNo}/${props.parselNo}`;
            try {
                const yapiResponse = await fetch(yapiUrl);
                if (yapiResponse.ok) {
                    const yapiData = await yapiResponse.json();
                    if (yapiData && yapiData.features && yapiData.features.length > 0) {
                        drawYapiAndIrtifakPolygons(yapiData);
                    }
                }
            } catch (e) { console.warn('YapÄ±/irtifak poligonlarÄ± alÄ±namadÄ±', e); }
            
        } catch (error) {
            console.error('TKGM API HatasÄ±:', error);
            showTkgmError(`TKGM verisi alÄ±namadÄ±: ${error.message}`);
        }
    }

    // TKGM loading gÃ¶ster
    function showTkgmLoading() {
        tkgmResults.style.display = 'block';
        tkgmLoading.style.display = 'block';
        parselInfo.style.display = 'none';
        tkgmError.style.display = 'none';
    }

    // TKGM verisini gÃ¶ster
    function displayTkgmData(basicData, bagimsizBolumData = null, cokBlokluBolumler = null) {
        tkgmLoading.style.display = 'none';
        parselInfo.style.display = 'grid';
        tkgmError.style.display = 'none';

        // Ã–nceki baÄŸÄ±msÄ±z bÃ¶lÃ¼m card'Ä±nÄ± temizle
        const existingCards = parselInfo.querySelectorAll('.bagimsiz-bolum-card');
        existingCards.forEach(card => card.remove());
        
        const props = basicData.properties;
        
        // Konum bilgileri
        locationDetails.innerHTML = `
            <div class="detail-item">
                <strong>ğŸ™ï¸ Ä°l:</strong>
                <span>${props.ilAd || 'BelirtilmemiÅŸ'}</span>
            </div>
            <div class="detail-item">
                <strong>ğŸ˜ï¸ Ä°lÃ§e:</strong>
                <span>${props.ilceAd || 'BelirtilmemiÅŸ'}</span>
            </div>
            <div class="detail-item">
                <strong>ğŸ  Mahalle:</strong>
                <span>${props.mahalleAd || 'BelirtilmemiÅŸ'}</span>
            </div>
            <div class="detail-item">
                <strong>ğŸ†” Mahalle ID:</strong>
                <span>${props.mahalleId || 'BelirtilmemiÅŸ'}</span>
            </div>
        `;
        
        // Parsel detaylarÄ±
        parselDetails.innerHTML = `
            <div class="detail-item">
                <strong>ğŸ“ Parsel No:</strong>
                <span>${props.parselNo || 'BelirtilmemiÅŸ'}</span>
            </div>
            <div class="detail-item">
                <strong>ğŸ—ï¸ Ada No:</strong>
                <span>${props.adaNo || 'BelirtilmemiÅŸ'}</span>
            </div>
            <div class="detail-item">
                <strong>ğŸ“ Alan:</strong>
                <span>${props.alan || 'BelirtilmemiÅŸ'} mÂ²</span>
            </div>
            <div class="detail-item">
                <strong>ğŸ“‹ Nitelik:</strong>
                <span>${props.nitelik || 'BelirtilmemiÅŸ'}</span>
            </div>
            <div class="detail-item">
                <strong>ğŸ¢ Zemin Durumu:</strong>
                <span>${props.zeminKmdurum || 'BelirtilmemiÅŸ'}</span>
            </div>
        `;
        
        // Geometri bilgileri
        let geometryHtml = '';
        if (basicData.geometry && basicData.geometry.coordinates) {
            const coordinates = basicData.geometry.coordinates[0];
            const area = calculatePolygonArea(coordinates);
            geometryHtml = `
                <div class="detail-item">
                    <strong>ğŸ”¢ Hesaplanan Alan:</strong>
                    <span>~${area.toFixed(2)} mÂ²</span>
                </div>
                <div class="coordinates-list">
                    <h4>ğŸ—ºï¸ Parsel SÄ±nÄ±r KoordinatlarÄ± (${coordinates.length} nokta)</h4>
            `;
            
            coordinates.forEach((coord) => {
                const [lng, lat] = coord;
                geometryHtml += `
                    <div class="coordinate-point">
                        ${lat.toFixed(8)}, ${lng.toFixed(8)}
                    </div>
                `;
            });
            
            geometryHtml += '</div>';
        } else {
            geometryHtml = '<p>Bu parsel iÃ§in geometri verisi bulunamadÄ±.</p>';
        }
        geometryDetails.innerHTML = geometryHtml;
        
        // Ham veri (tÃ¼m veriler)
        const allData = {
            parselBilgisi: basicData,
            bagimsizBolumler: bagimsizBolumData,
            cokBlokluBolumler: cokBlokluBolumler
        };
        rawJsonData.textContent = JSON.stringify(allData, null, 2);
        
        // Ã‡ok bloklu ise her blok iÃ§in ayrÄ± tablo gÃ¶ster
        if (cokBlokluBolumler && cokBlokluBolumler.length > 0) {
            cokBlokluBolumler.forEach(blokObj => {
                if (blokObj.data && blokObj.data.features && blokObj.data.features.length > 0) {
                    displayBagimsizBolumler(blokObj.data, blokObj.blok);
                } else {
                    // Blokta veri yoksa da baÅŸlÄ±k gÃ¶ster
                    displayBagimsizBolumler({ features: [] }, blokObj.blok);
                }
            });
        } else if (bagimsizBolumData && bagimsizBolumData.features && bagimsizBolumData.features.length > 0) {
            displayBagimsizBolumler(bagimsizBolumData);
        } else {
            console.log("GÃ¶rÃ¼ntÃ¼lenecek baÄŸÄ±msÄ±z bÃ¶lÃ¼m bulunmuyor.");
        }
    }

    // BaÄŸÄ±msÄ±z bÃ¶lÃ¼mleri gÃ¶ster
    function displayBagimsizBolumler(data, blokAdi = null) {
        const card = document.createElement('div');
        card.className = 'bagimsiz-bolum-card';

        // AÃ§Ä±lÄ±r/kapanÄ±r yapÄ±
        let summaryTitle = blokAdi ? `ğŸ¢ Blok: ${blokAdi}` : 'ğŸ  BaÄŸÄ±msÄ±z BÃ¶lÃ¼mler';
        let content = `
            <details>
                <summary style="font-size:1.1em; font-weight:bold; cursor:pointer;">
                    ${summaryTitle} (${data.features.length} adet)
                </summary>
        `;

        if (data.features && data.features.length > 0) {
            content += `
                <table class="bagimsiz-bolum-table">
                    <thead>
                        <tr>
                            <th>Blok</th>
                            <th>Kat</th>
                            <th>BÃ¶lÃ¼m No</th>
                            <th>Nitelik</th>
                            <th>Arsa PayÄ±</th>
                            <th>Arsa PayÄ± OranÄ± (%)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.features.forEach((bolum, idx) => {
                const props = bolum.properties;
                content += `
                    <tr>
                        <td>${props.blokAdi || props.blok || (blokAdi || '-')}</td>
                        <td>${props.katNo || props.kat || '-'}</td>
                        <td>${props.bagimsizBolumNo || props.no || '-'}</td>
                        <td>${props.nitelik || '-'}</td>
                        <td>
                            <input type="number" min="0" class="arsa-payi-input" data-row="${idx}" value="${props.arsaPayi || ''}" style="width:60px;text-align:right;" placeholder="pay">
                        </td>
                        <td class="arsa-oran-cell">%</td>
                    </tr>
                `;
            });

            // Payda inputu tablo altÄ±na ekleniyor
            content += `
                    <tr>
                        <td colspan="4" style="text-align:right;font-weight:bold;">Payda (Toplam):</td>
                        <td colspan="2">
                            <input type="number" min="1" class="arsa-paydasi-main-input" value="" style="width:80px;text-align:right;" placeholder="payda" readonly>
                        </td>
                    </tr>
            `;

            content += `
                    </tbody>
                </table>
            `;
        } else {
            content += '<p>Bu parsel iÃ§in baÄŸÄ±msÄ±z bÃ¶lÃ¼m bilgisi bulunamadÄ±.</p>';
        }

        content += '</details>';
        card.innerHTML = content;
        parselInfo.appendChild(card);

        // --- Dinamik oran hesaplama ---
        const payInputs = card.querySelectorAll('.arsa-payi-input');
        const paydaInput = card.querySelector('.arsa-paydasi-main-input');
        const oranCells = card.querySelectorAll('.arsa-oran-cell');

        // Payda: arsa paylarÄ±nÄ±n toplamÄ± (her deÄŸiÅŸiklikte gÃ¼ncellenir)
        function updatePaydaAndOranlar() {
            let toplam = 0;
            payInputs.forEach(input => {
                const val = parseFloat(input.value);
                if (!isNaN(val)) toplam += val;
            });
            paydaInput.value = toplam > 0 ? toplam : '';
            const payda = toplam;
            payInputs.forEach((input, i) => {
                const pay = parseFloat(input.value);
                let oran = '';
                if (!isNaN(pay) && payda > 0) {
                    oran = ((pay / payda) * 100).toFixed(2);
                }
                oranCells[i].textContent = oran ? `%${oran}` : '%';
            });
        }

        // Event listeners
        payInputs.forEach(input => {
            input.addEventListener('input', updatePaydaAndOranlar);
        });

        // Ä°lk yÃ¼klemede otomatik doldur
        updatePaydaAndOranlar();
    }

    // TKGM hatasÄ± gÃ¶ster
    function showTkgmError(message) {
        tkgmLoading.style.display = 'none';
        parselInfo.style.display = 'none';
        tkgmError.style.display = 'block';
        tkgmError.innerHTML = `
            <h4>âŒ TKGM Verisi AlÄ±namadÄ±</h4>
            <p>${message}</p>
            <small><strong>Ã‡Ã¶zÃ¼m Ã¶nerileri:</strong>
                <ul>
                    <li>Proxy server'Ä±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun</li>
                    <li>Internet baÄŸlantÄ±nÄ±zÄ± kontrol edin</li>
                    <li>FarklÄ± bir koordinat deneyin</li>
                </ul>
            </small>
        `;
    }

    // Polygon alanÄ± hesaplama (Shoelace formula)
    function calculatePolygonArea(coordinates) {
        let area = 0;
        const n = coordinates.length;
        
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            area += coordinates[i][0] * coordinates[j][1];
            area -= coordinates[j][0] * coordinates[i][1];
        }
        
        area = Math.abs(area) / 2;
        
        // Koordinat sistemini mÂ²'ye Ã§evir (yaklaÅŸÄ±k)
        const earthRadius = 6371000; // metre
        const latRad = (selectedCoordinates.lat * Math.PI) / 180;
        const degreeToMeter = earthRadius * Math.PI / 180;
        const areaInSquareMeters = area * degreeToMeter * degreeToMeter * Math.cos(latRad);
        
        return areaInSquareMeters;
    }

    // Parsel poligonunu Ã§iz
    function drawParselPolygon(data, props = null) {
        // Ã–nceki polygon'u kaldÄ±r
        if (parselPolygon) {
            parselPolygon.setMap(null);
        }
        
        if (!data.geometry || !data.geometry.coordinates) {
            console.log('Geometri verisi bulunamadÄ±');
            return;
        }
        
        const coordinates = data.geometry.coordinates[0];
        
        // Google Maps koordinat formatÄ±na Ã§evir
        const polygonCoords = coordinates.map(coord => ({
            lat: coord[1],
            lng: coord[0]
        }));
        
        // Polygon oluÅŸtur
        parselPolygon = new google.maps.Polygon({
            paths: polygonCoords,
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 3,
            fillColor: '#FF0000',
            fillOpacity: 0.2,
            editable: false,
            draggable: false
        });
        
        // Haritaya ekle
        parselPolygon.setMap(map);
        
        // Polygon'a zoom yap
        const bounds = new google.maps.LatLngBounds();
        polygonCoords.forEach(coord => bounds.extend(coord));
        map.fitBounds(bounds);
        
        // Poligon tÄ±klanÄ±nca modal aÃ§
        if (props) {
            parselPolygon.addListener('click', () => showParselModal(props));
        }
        
        console.log('Parsel poligonu Ã§izildi');
    }

    // Otomatik tamamlama iÅŸlemi
    function handleAutoComplete() {
        const query = searchInput.value.trim();
        
        if (query.length < 2) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        autocompleteService.getPlacePredictions({
            input: query,
            language: 'tr',
            types: ['establishment', 'geocode']
        }, (predictions, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                showSuggestions(predictions.slice(0, 5));
            } else {
                suggestionsDiv.style.display = 'none';
            }
        });
    }

    // Ã–nerileri gÃ¶sterme
    function showSuggestions(predictions) {
        suggestionsDiv.innerHTML = '';
        
        predictions.forEach(prediction => {
            const suggestionItem = document.createElement('div');
            suggestionItem.className = 'suggestion-item';
            suggestionItem.textContent = prediction.description;
            
            suggestionItem.addEventListener('click', () => {
                searchInput.value = prediction.description;
                suggestionsDiv.style.display = 'none';
                searchByPlaceId(prediction.place_id);
            });
            
            suggestionsDiv.appendChild(suggestionItem);
        });
        
        suggestionsDiv.style.display = 'block';
    }

    // Arama iÅŸlemi
    function performSearch() {
        const query = searchInput.value.trim();
        
        if (!query) {
            alert('LÃ¼tfen bir yer adÄ± girin');
            return;
        }

        suggestionsDiv.style.display = 'none';

        // Text search kullanarak arama
        const request = {
            query: query,
            language: 'tr'
        };

        placesService.textSearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results[0]) {
                const place = results[0];
                const location = place.geometry.location;
                
                // Harita tÄ±klama simÃ¼lasyonu
                handleMapClick(location);
                
                // Arama inputunu temizle
                searchInput.value = '';
            } else {
                alert('Yer bulunamadÄ±. LÃ¼tfen farklÄ± bir arama terimi deneyin.');
            }
        });
    }

    // Place ID ile arama
    function searchByPlaceId(placeId) {
        const request = {
            placeId: placeId,
            fields: ['name', 'formatted_address', 'geometry'],
            language: 'tr'
        };

        placesService.getDetails(request, (place, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                const location = place.geometry.location;
                handleMapClick(location);
            }
        });
    }

    // TÃ¼mÃ¼ temizle
    function clearAll() {
        // Input'u temizle
        searchInput.value = '';
        suggestionsDiv.style.display = 'none';
        
        // Koordinat bilgisini gizle
        coordinateInfo.style.display = 'none';
        selectedCoordinates = null;
        
        // TKGM sonuÃ§larÄ±nÄ± gizle
        tkgmResults.style.display = 'none';
        
        // Dinamik olarak eklenen baÄŸÄ±msÄ±z bÃ¶lÃ¼m card'Ä±nÄ± kaldÄ±r
        const bagimsizBolumCards = parselInfo.querySelectorAll('.bagimsiz-bolum-card');
        bagimsizBolumCards.forEach(card => card.remove());
        
        // Marker'Ä± kaldÄ±r
        if (marker) {
            marker.setMap(null);
            marker = null;
        }
        
        // Polygon'u kaldÄ±r
        if (parselPolygon) {
            parselPolygon.setMap(null);
            parselPolygon = null;
        }
        
        // YapÄ± ve irtifak poligonlarÄ±nÄ± temizle
        if (yapiPolygons && yapiPolygons.length > 0) {
            yapiPolygons.forEach(p => p.setMap(null));
            yapiPolygons = [];
        }
        
        // Emsal iÅŸaretÃ§ilerini temizle
        hepsiemlakMarkers.forEach(m => m.setMap(null));
        hepsiemlakMarkers = [];
        getHepsiEmlakBtn.style.display = 'none';
        
        console.log('TÃ¼mÃ¼ temizlendi');
    }

    // YapÄ± ve irtifak poligonlarÄ±nÄ± Ã§iz
    function drawYapiAndIrtifakPolygons(featureCollection) {
        // Ã–nceki poligonlarÄ± kaldÄ±r
        yapiPolygons.forEach(p => p.setMap(null));
        yapiPolygons = [];
        if (!featureCollection.features) return;
        featureCollection.features.forEach(feature => {
            const coords = feature.geometry.coordinates[0].map(coord => ({
                lat: coord[1],
                lng: coord[0]
            }));
            let color = '#007bff'; // default: yapÄ±
            if (feature.properties.tip === 'Irtifak_Hakki') color = '#28a745';
            const polygon = new google.maps.Polygon({
                paths: coords,
                strokeColor: color,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: color,
                fillOpacity: 0.25
            });
            polygon.setMap(map);
            yapiPolygons.push(polygon);
            // AlanÄ± ve tipi ekranda gÃ¶ster
            const alan = feature.properties.alan;
            const ad = feature.properties.ad;
            const tip = feature.properties.tip;
            geometryDetails.innerHTML += `
                <div class="detail-item">
                    <strong>${tip === 'Yapi' ? 'ğŸ¢ YapÄ±' : 'ğŸŸ© Ä°rtifak'} (${ad}):</strong>
                    <span>${alan.toFixed(2)} mÂ²</span>
                </div>
            `;
        });
    }

    // Show Parsel Modal
    function showParselModal(props) {
        const table = document.getElementById('modalParselTable');
        table.innerHTML = `
          <tr><td>Ä°l</td><td>${props.ilAd || '-'}</td></tr>
          <tr><td>Ä°lÃ§e</td><td>${props.ilceAd || '-'}</td></tr>
          <tr><td>Mahalle</td><td>${props.mahalleAd || '-'}</td></tr>
          <tr><td>Mahalle No</td><td>${props.mahalleId || '-'}</td></tr>
          <tr><td>Ada</td><td>${props.adaNo || '-'}</td></tr>
          <tr><td>Parsel</td><td>${props.parselNo || '-'}</td></tr>
          <tr><td>Tapu AlanÄ±</td><td>${props.alan || '-'}</td></tr>
          <tr><td>Nitelik</td><td>${props.nitelik || '-'}</td></tr>
          <tr><td>Zemin Tip</td><td>${props.zeminKmdurum || '-'}</td></tr>
          <tr><td>Pafta</td><td>${props.pafta || '-'}</td></tr>
        `;
        document.getElementById('parselModal').style.display = 'flex';
    }

    // Close Parsel Modal
    function closeParselModal() {
        document.getElementById('parselModal').style.display = 'none';
    }
    document.getElementById('closeParselModal').onclick = closeParselModal;
    document.getElementById('parselModal').onclick = function(e) {
        if (e.target === this) closeParselModal();
    };

    // Emsal verilerini al
    async function getHepsiEmlakData() {
        if (!selectedCoordinates) {
            alert('Ã–nce haritadan bir nokta seÃ§in');
            return;
        }
        // 1500m x 1500m kutu iÃ§in yarÄ±Ã§ap
        const boxSize = 1500; // metre
        const half = boxSize / 2;
        const lat = selectedCoordinates.lat;
        const lng = selectedCoordinates.lng;
        // 1 derece enlem â‰ˆ 111320 metre
        const latDelta = half / 111320;
        // 1 derece boylam â‰ˆ 111320 * cos(lat)
        const lngDelta = half / (111320 * Math.cos(lat * Math.PI / 180));
        const topLeft = `${lat + latDelta},${lng - lngDelta}`;
        const bottomRight = `${lat - latDelta},${lng + lngDelta}`;
        const url = `http://localhost:5000/api/hepsiemlak?mapSize=1500&intent=kiralik&mainCategory=konut&buildingAges=0-0,1-5,6-10&mapTopLeft=${topLeft}&mapBottomRight=${bottomRight}`;
        // UI: Ã–nceki markerlarÄ± temizle
        hepsiemlakMarkers.forEach(m => m.setMap(null));
        hepsiemlakMarkers = [];
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.realties && data.realties.length > 0) {
                data.realties.forEach(item => {
                    const marker = new google.maps.Marker({
                        position: { lat: item.mapLocation.lat, lng: item.mapLocation.lon },
                        map: map,
                        icon: {
                            url: "https://cdn-icons-png.flaticon.com/512/69/69524.png",
                            scaledSize: new google.maps.Size(32, 32)
                        },
                        title: `Fiyat: ${item.price} ${item.currency}`
                    });
                    const info = new google.maps.InfoWindow({
                        content: `<b>Fiyat:</b> ${item.price} ${item.currency}<br><a href="https://www.hepsiemlak.com/ilan/${item.listingId}" target="_blank">Ä°lanÄ± GÃ¶r</a>`
                    });
                    marker.addListener('click', () => info.open(map, marker));
                    hepsiemlakMarkers.push(marker);
                });
            } else {
                alert("Bu bÃ¶lgede emsal ilan bulunamadÄ±.");
            }
        } catch (e) {
            alert("HepsiEmlak verisi alÄ±namadÄ±: " + e.message);
        }
    }

    // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Sayfa yÃ¼klendi, Google Maps bekleniyor...');
    });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCObeHN49sOzFlSWSpsiO5vAHH7TeqOYxg&libraries=places&callback=initMap"></script>
</body>
</html> 